# DAQ 2.2.2 with dpdk18.08 multi-queue (RSS) and HW offload support

The DPDK DAQ has been updated to version 2.2.2 with support for DPDK 18.05.

## How to setup

1. Download the Napatech DPDK 18.08 and build it
It can be downloaded here: https://github.com/napatech/dpdk/releases
A desription on how to buld and setup DPDK can be found here: http://dpdk.org/doc/quick-start and here http://dpdk.org/doc/guides/linux_gsg/index.html

	The environment variable RTE_SDK must be set to the DPDK root before building the DAQ module and Snort.

	```bash
	export RTE_SDK=<DPDK root directory>
	```
2. Enable HW offload
In the file `daq_dpdk.c` set:
```c++
#define USE_HW_OFFLOAD 1
```
 
3. Download or clone this DAQ 2.2.2 modified version:
```bash
# cd daq-2.2.2
# ./configure --prefix=/opt/snort 
# make
# make install
```
4. Download Snort 3.0 and build/install it. - currently it is only an alpha version that is available.
```bash
# ./configure_cmake.sh --prefix=/opt/snort --with-daq-libraries=/opt/snort/lib --with-daq-includes=/opt/snort/include
# cd build
# make -j
# make install
```

## HW offload support (inline only)
HW offload is done when Snort returns verdict command:
- `DAQ_VERDICT_WHITELIST`
- `DAQ_VERDICT_BLACKLIST`
- `DAQ_VERDICT_IGNORE`

`DAQ_VERDICT_WHITELIST` and `DAQ_VERDICT_IGNORE` cause a forward filter to be created. The forward filter will forward packets in hardware between the 2 inline ports. This is done by creating a DPDK rte_flow filter with the action `RTE_FLOW_ACTION_TYPE_PORT_ID`.

`DAQ_VERDICT_BLACKLIST` causes a drop filter to be created. The drop filter will drop packets in hardware. This is done by creating a DPDK rte_flow filter with action `RTE_FLOW_ACTION_TYPE_DROP`.

When the forward and/or the drop filters are created, no packets matching the filter will be transmitted to Snort.

The forward/drop filter has a timeout on 60 seconds. Then the filter will be deleted and Snort will receive packets again. Snort will then remake the filter.

## How to use

Snort in inline mode (IPS) using 14 RSS queues and 14 cores on 1 interface pair:
```bash
# taskset -c 0-13 snort --daq dpdk --daq-var dpdk_argc="-n4" -i "dpdk0:dpdk1" -Q -z 14
```

Snort in inline mode (IPS) using 2 RSS queues and 14 cores on 2 interface pairs:
```bash
# taskset -c 0-13 snort --daq dpdk --daq-var dpdk_argc="-n4" -i "dpdk0:dpdk1 dpdk2:dpdk3" -Q -z 14
```

Snort in passive mode (IDS) using 14 RSS queues and 14 cores on 2 interfaces:
```bash
# taskset -c 0-13 snort --daq dpdk --daq-var dpdk_argc="-n4" -i "dpdk0 dpdk1" -z 14
```

Snort in passive mode (IDS) using 2 RSS queues and 4 cores on 1 interfaces:
```bash
# taskset -c 0-13 snort --daq dpdk --daq-var dpdk_argc="-n4" -i "dpdk0" -z 2
```

Note: taskset is used here to pin the cores used by Snort to run only on NUMA 0. This is done to avoid QPI 
utilization. Run the cores on the same NUMA node as the NIC is sitting on.

a. Only one interface specifier is supported, but that may contain multiple interfaces and/or interface pairs.

b. When specifying inline mode (-Q) the interface specification must only contain pairs, separated by ":" 
   (dpdk0:dpdk1 dpdk2:dpdk3).
   
c. Each pair in inline mode is bidirectional, thus both directions are handled by each thread. This way Snort 
   keeps track of bi-directional protocols.
   
d. When using RSS (multiple queues) the HW hashing algorithm used (at least specified) is as follows:  
   5tuple - ETH_RSS_UDP | ETH_RSS_TCP | ETH_RSS_SCTP. This means that the key is generated by IP address and UDP/TCP/SCTP port
   numbers.
   
e. Additionally an option "--daq-var debug" may be specified. This will print out various interesting information 
   about the Rx and Tx trafic and this is done per thread, so that the load balancing may be visualized.

